{% extends "layout.html" %}

{% block title %}System Architecture - WhereSpace{% endblock %}

{% block extra_styles %}
<style>
    .architecture-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    .diagram-section {
        background: white;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--light);
    }

    .section-title {
        font-size: 24px;
        font-weight: 600;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .diagram-controls {
        display: flex;
        gap: 10px;
    }

    .control-btn {
        padding: 8px 16px;
        border: 2px solid var(--primary);
        background: white;
        color: var(--primary);
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
    }

    .control-btn:hover {
        background: var(--primary);
        color: white;
    }

    .mermaid-diagram {
        background: white;
        padding: 20px;
        border-radius: 8px;
        overflow-x: auto;
        min-height: 400px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .legend-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: var(--light);
        border-radius: 8px;
    }

    .legend-color {
        width: 30px;
        height: 30px;
        border-radius: 6px;
        border: 2px solid #ddd;
    }

    .legend-label {
        font-size: 14px;
        color: #555;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .info-card {
        background: var(--light);
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid var(--primary);
    }

    .info-card h4 {
        font-size: 18px;
        color: var(--primary);
        margin-bottom: 10px;
    }

    .info-card ul {
        list-style: none;
        padding: 0;
    }

    .info-card li {
        padding: 8px 0;
        border-bottom: 1px solid #e0e0e0;
        font-size: 14px;
        color: #666;
    }

    .info-card li:last-child {
        border-bottom: none;
    }

    .info-card li strong {
        color: var(--dark);
        font-weight: 600;
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }

    .metric-card {
        text-align: center;
        padding: 20px;
        background: linear-gradient(135deg, var(--primary) 0%, #667eea 100%);
        color: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .metric-value {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .metric-label {
        font-size: 14px;
        opacity: 0.9;
    }

    .tech-stack {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
    }

    .tech-badge {
        padding: 8px 16px;
        background: white;
        border: 2px solid var(--primary);
        border-radius: 20px;
        font-size: 14px;
        color: var(--primary);
        font-weight: 600;
    }

    .loading-diagram {
        text-align: center;
        padding: 60px 20px;
        color: #999;
    }

    .loading-diagram .spinner {
        margin: 0 auto 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="architecture-container">
    <!-- System Overview -->
    <div class="diagram-section">
        <div class="section-header">
            <h2 class="section-title">
                System Overview
            </h2>
        </div>
        
        <p style="font-size: 16px; color: #666; line-height: 1.6; margin-bottom: 20px;">
            <strong>JW zijn babbeldoos</strong> is een productie-klare RAG (Retrieval-Augmented Generation) applicatie 
            gebouwd met Flask, PostgreSQL, pgvector en Ollama. Het systeem combineert vector similarity search 
            met lokale LLM's voor intelligente document query's.
        </p>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value">6-8x</div>
                <div class="metric-label">Snellere Indexering</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">3-5x</div>
                <div class="metric-label">Snellere Queries</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">10-20x</div>
                <div class="metric-label">Concurrent Capacity</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">768D</div>
                <div class="metric-label">Vector Embeddings</div>
            </div>
        </div>
    </div>

    <!-- Architecture Diagram -->
    <div class="diagram-section">
        <div class="section-header">
            <h2 class="section-title">
                Architecture Diagram
            </h2>
            <div class="diagram-controls">
                <button class="control-btn" onclick="zoomIn()">Zoom In</button>
                <button class="control-btn" onclick="zoomOut()">Zoom Out</button>
                <button class="control-btn" onclick="resetZoom()">Reset</button>
            </div>
        </div>

        <div id="mermaid-container" class="mermaid-diagram">
            <div class="loading-diagram">
                <div class="spinner"></div>
                <p>Diagram laden...</p>
            </div>
        </div>

        <!-- Legend -->
        <div class="legend-grid">
            <div class="legend-item">
                <div class="legend-color" style="background: #e1f5ff; border-color: #01579b;"></div>
                <span class="legend-label"><strong>Client Layer</strong> - Web &amp; CLI interfaces</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f3e5f5; border-color: #4a148c;"></div>
                <span class="legend-label"><strong>Application Layer</strong> - Flask web server</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #fff3e0; border-color: #e65100;"></div>
                <span class="legend-label"><strong>Core Processing</strong> - Document pipeline</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #e8f5e9; border-color: #1b5e20;"></div>
                <span class="legend-label"><strong>External Services</strong> - Ollama LLM</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #fce4ec; border-color: #880e4f;"></div>
                <span class="legend-label"><strong>Data Layer</strong> - PostgreSQL + pgvector</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f1f8e9; border-color: #33691e;"></div>
                <span class="legend-label"><strong>Storage Layer</strong> - File system</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #fff9c4; border-color: #f57f17;"></div>
                <span class="legend-label"><strong>Optimizations</strong> - Performance features</span>
            </div>
        </div>
    </div>

    <!-- Technical Details -->
    <div class="diagram-section">
        <div class="section-header">
            <h2 class="section-title">
                Technical Details
            </h2>
        </div>

        <div class="info-grid">
            <!-- Layers -->
            <div class="info-card">
                <h4>Architectuur Lagen</h4>
                <ul>
                    <li><strong>Client:</strong> Web Browser, Terminal</li>
                    <li><strong>Application:</strong> Flask (Python)</li>
                    <li><strong>Processing:</strong> Document Pipeline</li>
                    <li><strong>Services:</strong> Ollama LLM Server</li>
                    <li><strong>Data:</strong> PostgreSQL + pgvector</li>
                    <li><strong>Storage:</strong> Local File System</li>
                </ul>
            </div>

            <!-- Key Components -->
            <div class="info-card">
                <h4>Belangrijkste Components</h4>
                <ul>
                    <li><strong>WhereSpaceChat.py:</strong> Flask web server</li>
                    <li><strong>WhereSpace.py:</strong> Document ingestion</li>
                    <li><strong>model_manager.py:</strong> LLM management</li>
                    <li><strong>evaluate_rag.py:</strong> Quality metrics</li>
                    <li><strong>batch_embeddings.py:</strong> Parallel processing</li>
                </ul>
            </div>

            <!-- Data Flow -->
            <div class="info-card">
                <h4>Data Flows</h4>
                <ul>
                    <li><strong>Indexing:</strong> Files ? Extract ? Chunk ? Embed ? DB</li>
                    <li><strong>Query:</strong> Question ? Embed ? Search ? Rank ? LLM</li>
                    <li><strong>Management:</strong> UI ? API ? Ollama/PostgreSQL</li>
                </ul>
            </div>

            <!-- Performance -->
            <div class="info-card">
                <h4>Performance Features</h4>
                <ul>
                    <li><strong>Connection Pool:</strong> 2-10 connections</li>
                    <li><strong>Query Cache:</strong> LRU, 5 min TTL</li>
                    <li><strong>Parallel Processing:</strong> 4 workers</li>
                    <li><strong>Re-ranking:</strong> Semantic similarity</li>
                    <li><strong>Deduplication:</strong> Content hashing</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Tech Stack -->
    <div class="diagram-section">
        <div class="section-header">
            <h2 class="section-title">
                Technology Stack
            </h2>
        </div>

        <h4 style="margin-bottom: 15px; color: #666;">Backend &amp; Core</h4>
        <div class="tech-stack">
            <span class="tech-badge">Python 3.8+</span>
            <span class="tech-badge">Flask 3.0</span>
            <span class="tech-badge">PostgreSQL 14+</span>
            <span class="tech-badge">pgvector 0.5+</span>
            <span class="tech-badge">psycopg2</span>
            <span class="tech-badge">Ollama</span>
        </div>

        <h4 style="margin: 20px 0 15px 0; color: #666;">Document Processing</h4>
        <div class="tech-stack">
            <span class="tech-badge">pypdf</span>
            <span class="tech-badge">python-docx</span>
            <span class="tech-badge">nomic-embed-text</span>
            <span class="tech-badge">Recursive Chunking</span>
        </div>

        <h4 style="margin: 20px 0 15px 0; color: #666;">LLM Models</h4>
        <div class="tech-stack">
            <span class="tech-badge">llama3.1</span>
            <span class="tech-badge">mistral</span>
            <span class="tech-badge">gemma2</span>
            <span class="tech-badge">qwen2.5</span>
        </div>

        <h4 style="margin: 20px 0 15px 0; color: #666;">Frontend &amp; UI</h4>
        <div class="tech-stack">
            <span class="tech-badge">Jinja2 Templates</span>
            <span class="tech-badge">Vanilla JavaScript</span>
            <span class="tech-badge">CSS3</span>
            <span class="tech-badge">Server-Sent Events</span>
        </div>
    </div>

    <!-- Database Schema -->
    <div class="diagram-section">
        <div class="section-header">
            <h2 class="section-title">
                Database Schema
            </h2>
        </div>

        <div style="background: var(--light); padding: 20px; border-radius: 8px; font-family: monospace; overflow-x: auto;">
            <pre style="margin: 0; color: #333; line-height: 1.6;">
<strong>Table: documents</strong>

id              SERIAL PRIMARY KEY
file_path       TEXT NOT NULL
chunk_index     INTEGER NOT NULL
file_name       TEXT NOT NULL
file_type       TEXT
content_preview TEXT
chunk_content   TEXT
file_size       BIGINT
modified_time   FLOAT
embedding       vector(768)
created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP
UNIQUE(file_path, chunk_index)

<strong>Indexes:</strong>

1. documents_embedding_idx (IVFFlat)
   vector_cosine_ops, lists=100

2. documents_file_path_idx (B-tree)
   file_path
            </pre>
        </div>
    </div>

    <!-- Performance Metrics -->
    <div class="diagram-section">
        <div class="section-header">
            <h2 class="section-title">
                Performance Benchmarks
            </h2>
        </div>

        <div class="info-grid">
            <div class="info-card" style="border-left-color: #4caf50;">
                <h4 style="color: #4caf50;">Ingestion Performance</h4>
                <ul>
                    <li><strong>100 docs:</strong> 35-40s (was 4 min)</li>
                    <li><strong>Throughput:</strong> 12-15 chunks/sec</li>
                    <li><strong>Speedup:</strong> 6-8x faster</li>
                </ul>
            </div>

            <div class="info-card" style="border-left-color: #2196f3;">
                <h4 style="color: #2196f3;">Query Performance</h4>
                <ul>
                    <li><strong>First response:</strong> 200-400ms</li>
                    <li><strong>Cached queries:</strong> &lt;5ms</li>
                    <li><strong>Full response:</strong> 1-3s</li>
                </ul>
            </div>

            <div class="info-card" style="border-left-color: #ff9800;">
                <h4 style="color: #ff9800;">Scalability</h4>
                <ul>
                    <li><strong>Concurrent users:</strong> 10-20</li>
                    <li><strong>Documents:</strong> 50 (configurable)</li>
                    <li><strong>Vectors:</strong> Up to 1M+</li>
                </ul>
            </div>

            <div class="info-card" style="border-left-color: #9c27b0;">
                <h4 style="color: #9c27b0;">Quality Metrics</h4>
                <ul>
                    <li><strong>Hit Rate:</strong> 80-95%</li>
                    <li><strong>Re-ranking:</strong> +5-10% quality</li>
                    <li><strong>Deduplication:</strong> 20-40% smaller prompts</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Mermaid.js - Try CDN first, fall back to local if it fails -->
<script>
    console.log('Architecture page loaded - v5 with smart loading');
    
    // Try to load from CDN first (most reliable)
    const cdnScript = document.createElement('script');
    cdnScript.src = 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js';
    cdnScript.crossOrigin = 'anonymous';
    
    let mermaidLoaded = false;
    let loadTimeout;
    
    // Set a timeout for CDN loading (3 seconds)
    loadTimeout = setTimeout(() => {
        if (!mermaidLoaded && typeof mermaid === 'undefined') {
            console.log('CDN timeout, trying local file...');
            tryLocalFile();
        }
    }, 3000);
    
    cdnScript.onload = function() {
        clearTimeout(loadTimeout);
        mermaidLoaded = true;
        console.log('? Mermaid loaded from CDN');
        initializeMermaid();
    };
    
    cdnScript.onerror = function() {
        clearTimeout(loadTimeout);
        console.log('CDN failed, trying local file...');
        tryLocalFile();
    };
    
    document.head.appendChild(cdnScript);
    
    // Function to try loading from local file
    function tryLocalFile() {
        if (mermaidLoaded) return;
        
        const localScript = document.createElement('script');
        localScript.src = '{{ url_for("static", filename="mermaid.min.js") }}?t={{ range(1, 9999999) | random }}';
        
        localScript.onload = function() {
            mermaidLoaded = true;
            console.log('? Mermaid loaded from local file');
            initializeMermaid();
        };
        
        localScript.onerror = function() {
            console.error('? Both CDN and local file failed');
            showError('Failed to load Mermaid', 'Could not load diagram library from CDN or local file');
        };
        
        document.head.appendChild(localScript);
    }
    
    // Mermaid diagram code
    const diagramCode = `graph LR
    A[Client] --> B[Flask Server]
    B --> C[PostgreSQL]
    B --> D[Ollama]
    C --> E[pgvector]
    D --> F[LLM Models]
    
    style A fill:#e1f5ff,stroke:#01579b
    style B fill:#f3e5f5,stroke:#4a148c
    style C fill:#fce4ec,stroke:#880e4f
    style D fill:#e8f5e9,stroke:#1b5e20
    style E fill:#fce4ec,stroke:#880e4f
    style F fill:#e8f5e9,stroke:#1b5e20`;

    // Zoom controls
    let zoomLevel = 1;
    const zoomStep = 0.1;
    const minZoom = 0.5;
    const maxZoom = 2;

    function zoomIn() {
        if (zoomLevel < maxZoom) {
            zoomLevel += zoomStep;
            applyZoom();
        }
    }

    function zoomOut() {
        if (zoomLevel > minZoom) {
            zoomLevel -= zoomStep;
            applyZoom();
        }
    }

    function resetZoom() {
        zoomLevel = 1;
        applyZoom();
    }

    function applyZoom() {
        const svg = document.querySelector('#mermaid-container svg');
        if (svg) {
            svg.style.transform = `scale(${zoomLevel})`;
            svg.style.transformOrigin = 'center center';
        }
    }

    function showError(title, message) {
        const container = document.getElementById('mermaid-container');
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #d32f2f;">
                <h3>${title}</h3>
                <p style="color: #666; margin-top: 10px;">${message}</p>
                <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 20px;">
                    Reload Page
                </button>
            </div>
        `;
    }

    // Initialize Mermaid once loaded
    function initializeMermaid() {
        console.log('Initializing Mermaid...');
        
        // Wait a bit for Mermaid to be fully available
        let attempts = 0;
        const checkInterval = setInterval(() => {
            attempts++;
            
            if (typeof mermaid !== 'undefined') {
                console.log('? Mermaid is ready!');
                clearInterval(checkInterval);
                renderDiagram();
            } else if (attempts >= 50) {
                console.error('? Mermaid not available after loading');
                clearInterval(checkInterval);
                showError('Mermaid Not Available', 'Library loaded but not initialized');
            }
        }, 100);
    }

    // Render diagram
    async function renderDiagram() {
        console.log('Starting diagram render...');
        
        try {
            const container = document.getElementById('mermaid-container');
            
            // Initialize Mermaid
            mermaid.initialize({ 
                startOnLoad: false,
                theme: 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true,
                    curve: 'basis'
                }
            });
            
            console.log('Rendering diagram...');
            
            // Render the diagram
            const { svg } = await mermaid.render('mermaid-diagram-svg', diagramCode);
            
            console.log('Diagram rendered successfully');
            
            // Insert rendered SVG
            container.innerHTML = svg;
            
            // Make diagram responsive
            const svgElement = container.querySelector('svg');
            if (svgElement) {
                svgElement.style.maxWidth = '100%';
                svgElement.style.height = 'auto';
            }
            
            console.log('? Architecture diagram displayed successfully!');
            
        } catch (error) {
            console.error('Error rendering diagram:', error);
            showError('Rendering Error', `Failed to render diagram: ${error.message}`);
        }
    }
</script>
{% endblock %}
