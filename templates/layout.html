<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}WhereSpace - AI Document Intelligence{% endblock %}</title>
    
    <style>
        /* Modern Dashboard Styling */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #764ba2;
            --secondary: #f093fb;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #f44336;
            --light: #f8f9fa;
            --dark: #2c3e50;
            --sidebar-width: 260px;
            --topbar-height: 64px;
            --chat-width: 400px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--light);
            color: var(--dark);
            overflow-x: hidden;
        }

        /* Top Bar */
        .topbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--topbar-height);
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            padding: 0 30px;
            z-index: 1000;
        }

        .topbar-logo {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-right: 30px;
        }

        .topbar-right {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .model-display {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            color: white;
        }

        .model-icon {
            font-size: 18px;
        }

        .model-loading-spinner {
            display: none;
            width: 16px;
            height: 16px;
            margin-left: 8px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--light);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: var(--topbar-height);
            bottom: 0;
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
            z-index: 900;
            transition: transform 0.3s;
        }

        .sidebar.collapsed {
            transform: translateX(calc(-1 * var(--sidebar-width)));
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 30px;
            color: var(--dark);
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--light);
            border-left-color: var(--primary);
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.1) 0%, transparent 100%);
            border-left-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        .nav-icon {
            font-size: 20px;
            margin-right: 12px;
            width: 24px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            margin-top: var(--topbar-height);
            padding: 30px;
            min-height: calc(100vh - var(--topbar-height));
            transition: margin-left 0.3s;
        }

        .main-content.sidebar-collapsed {
            margin-left: 0;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(calc(-1 * var(--sidebar-width)));
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .chat-panel {
                width: 100%;
            }
        }

        /* Typing animation */
        @keyframes typing {
            0%, 60%, 100% { 
                transform: translateY(0); 
                opacity: 1;
            }
            30% { 
                transform: translateY(-6px); 
                opacity: 0.7;
            }
        }

        {% block extra_styles %}{% endblock %}
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="topbar">
        <div class="topbar-logo">WhereSpace</div>
        <div class="topbar-right">
            <div class="model-display" id="model-display">
                <span class="model-icon">ü§ñ</span>
                <span id="current-model-name">Loading...</span>
                <span class="model-loading-spinner" id="model-loading-spinner" style="display: none;">
                    <svg width="16" height="16" viewBox="0 0 24 24" style="animation: spin 1s linear infinite; margin-left: 8px;">
                        <circle cx="12" cy="12" r="10" stroke="white" stroke-width="3" fill="none" stroke-dasharray="31.4 31.4" stroke-linecap="round">
                            <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s" repeatCount="indefinite"/>
                        </circle>
                    </svg>
                </span>
            </div>
            <div class="status-badge">
                <span class="status-dot"></span>
                <span id="doc-count">Loading...</span>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <nav class="sidebar-nav">
            <a href="/ingest" class="nav-item {% if request.endpoint == 'ingest' or request.endpoint == 'index' %}active{% endif %}">
                <span class="nav-icon">üì•</span>
                <span>Document Management</span>
            </a>
            <a href="/storage" class="nav-item {% if request.endpoint == 'storage' %}active{% endif %}">
                <span class="nav-icon">üíæ</span>
                <span>Storage Analysis</span>
            </a>
            <a href="/dashboard" class="nav-item {% if request.endpoint == 'dashboard' %}active{% endif %}">
                <span class="nav-icon">üìä</span>
                <span>Dashboard</span>
            </a>
            <a href="/models" class="nav-item {% if request.endpoint == 'models' %}active{% endif %}">
                <span class="nav-icon">ü§ñ</span>
                <span>Models</span>
            </a>
            <a href="/architecture" class="nav-item {% if request.endpoint == 'architecture' %}active{% endif %}">
                <span class="nav-icon">üèóÔ∏è</span>
                <span>Architecture</span>
            </a>
            <a href="/evaluation" class="nav-item {% if request.endpoint == 'evaluation' %}active{% endif %}">
                <span class="nav-icon">üìà</span>
                <span>Evaluation</span>
            </a>
            <a href="/settings" class="nav-item {% if request.endpoint == 'settings' %}active{% endif %}">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span>Settings</span>
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="main-content">
        {% block content %}{% endblock %}
    </div>

    <script>
        // Topbar state cache to prevent "Loading..." flash on navigation
        const TOPBAR_CACHE_KEY = 'wherespace_topbar_state';
        const CACHE_DURATION = 30000; // 30 seconds

        // Show/hide model loading spinner
        function showModelLoading(show = true) {
            const spinner = document.getElementById('model-loading-spinner');
            const modelName = document.getElementById('current-model-name');
            if (spinner) {
                spinner.style.display = show ? 'inline-block' : 'none';
            }
            if (modelName && show) {
                modelName.style.opacity = '0.6';
            } else if (modelName) {
                modelName.style.opacity = '1';
            }
        }

        // Load cached topbar state immediately
        function loadCachedState() {
            try {
                const cached = sessionStorage.getItem(TOPBAR_CACHE_KEY);
                if (cached) {
                    const state = JSON.parse(cached);
                    const now = Date.now();
                    
                    // Use cache if less than 30 seconds old
                    if (state.timestamp && (now - state.timestamp) < CACHE_DURATION) {
                        // Update UI immediately from cache
                        const docCountEl = document.getElementById('doc-count');
                        if (docCountEl && state.docCount !== undefined) {
                            docCountEl.textContent = state.docCount ? `${state.docCount} docs` : 'No docs';
                        }
                        
                        const modelNameEl = document.getElementById('current-model-name');
                        if (modelNameEl && state.modelName) {
                            modelNameEl.textContent = state.modelName;
                        }
                        
                        return true; // Cache was valid and used
                    }
                }
            } catch (error) {
                console.error('Error loading cached state:', error);
            }
            return false; // No valid cache
        }

        // Save topbar state to cache
        function saveCachedState(docCount, modelName) {
            try {
                const state = {
                    docCount: docCount,
                    modelName: modelName,
                    timestamp: Date.now()
                };
                sessionStorage.setItem(TOPBAR_CACHE_KEY, JSON.stringify(state));
            } catch (error) {
                console.error('Error saving cached state:', error);
            }
        }

        // Load status and current model on page load
        async function loadStatus() {
            showModelLoading(true);
            
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // Update document count
                const docCountEl = document.getElementById('doc-count');
                if (docCountEl) {
                    docCountEl.textContent = data.document_count ? `${data.document_count} docs` : 'No docs';
                }
                
                // Update current model display
                let formattedName = '';
                if (data.current_model) {
                    const modelName = data.current_model.replace(':latest', '').replace(/[_-]/g, ' ');
                    formattedName = modelName.split(' ').map(word => 
                        word.charAt(0).toUpperCase() + word.slice(1)
                    ).join(' ');
                    const modelNameEl = document.getElementById('current-model-name');
                    if (modelNameEl) {
                        modelNameEl.textContent = formattedName;
                    }
                }
                
                // Cache the state
                saveCachedState(data.document_count, formattedName);
                
            } catch (error) {
                console.error('Error loading status:', error);
                const modelNameEl = document.getElementById('current-model-name');
                if (modelNameEl) {
                    modelNameEl.textContent = 'Error loading model';
                }
            } finally {
                showModelLoading(false);
            }
        }

        // Load available models (keeping for compatibility with other pages)
        async function loadModels() {
            try {
                const response = await fetch('/api/models');
                const data = await response.json();
                
                if (data.success && data.current_model) {
                    // Update model display if present
                    const modelName = data.current_model.replace(':latest', '').replace(/[_-]/g, ' ');
                    const formattedName = modelName.split(' ').map(word => 
                        word.charAt(0).toUpperCase() + word.slice(1)
                    ).join(' ');
                    const modelNameEl = document.getElementById('current-model-name');
                    if (modelNameEl) {
                        modelNameEl.textContent = formattedName;
                    }
                    console.log(`Current model: ${data.current_model}`);
                }
            } catch (error) {
                console.error('Error loading models:', error);
            }
        }

        // Switch model with progress indicator
        async function switchModel(modelId) {
            showModelLoading(true);
            
            try {
                const response = await fetch('/api/set_model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: modelId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log(`Model switched to: ${modelId}`);
                    // Reload status to update display
                    await loadStatus();
                } else {
                    console.error('Failed to switch model:', data.error);
                    alert('Failed to switch model: ' + data.error);
                }
            } catch (error) {
                console.error('Error switching model:', error);
                alert('Error switching model: ' + error.message);
            } finally {
                showModelLoading(false);
            }
        }

        // Initialize - call immediately if DOM is already loaded, otherwise wait
        function initializeTopbar() {
            console.log('Initializing topbar...');
            
            // Try to load from cache first (instant, no "Loading..." flash)
            const usedCache = loadCachedState();
            
            // Always fetch fresh data, but cache prevents "Loading..." flash
            loadStatus();
            
            // Only call loadModels if cache wasn't used (avoid redundant call)
            if (!usedCache) {
                loadModels();
            }
            
            // Refresh status every 30 seconds
            setInterval(loadStatus, 30000);
        }

        // Run initialization based on document state
        if (document.readyState === 'loading') {
            // DOM is still loading, wait for DOMContentLoaded
            document.addEventListener('DOMContentLoaded', initializeTopbar);
        } else {
            // DOM is already loaded, run immediately
            initializeTopbar();
        }
    </script>

    {% block extra_scripts %}{% endblock %}
</body>
</html>
