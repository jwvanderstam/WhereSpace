{% extends "layout.html" %}

{% block title %}Ingest Documents - WhereSpace{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h1 class="card-title">?? Document Management</h1>
    </div>
    
    <p style="font-size: 16px; line-height: 1.8; margin-bottom: 30px;">
        Manage your document collection: scan directories, ingest documents, and view your indexed data.
        Supported formats: PDF, DOCX, TXT, MD, and more.
    </p>

    <!-- Database Statistics -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">?? Database Statistics</h2>
            <button class="btn btn-primary" onclick="loadStatistics()" style="background: var(--primary);">
                ?? Refresh
            </button>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center;">
                <div style="font-size: 36px; font-weight: 700; margin-bottom: 5px;" id="stat-documents">-</div>
                <div style="font-size: 14px; opacity: 0.9;">Documents Indexed</div>
            </div>
            
            <div class="card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; text-align: center;">
                <div style="font-size: 36px; font-weight: 700; margin-bottom: 5px;" id="stat-chunks">-</div>
                <div style="font-size: 14px; opacity: 0.9;">Total Chunks</div>
            </div>
            
            <div class="card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; text-align: center;">
                <div style="font-size: 36px; font-weight: 700; margin-bottom: 5px;" id="stat-size">-</div>
                <div style="font-size: 14px; opacity: 0.9;">Total Size</div>
            </div>
            
            <div class="card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; text-align: center;">
                <div style="font-size: 36px; font-weight: 700; margin-bottom: 5px;" id="stat-avg-chunk">-</div>
                <div style="font-size: 14px; opacity: 0.9;">Avg Chunk Size</div>
            </div>
        </div>
    </div>

    <!-- Indexed Documents List -->
    <div class="card" id="documents-list-section">
        <div class="card-header">
            <h2 class="card-title">?? Indexed Documents</h2>
            <button class="btn" onclick="deleteAllDocuments()" style="background: var(--danger); color: white;">
                ??? Delete All
            </button>
        </div>
        
        <div id="indexed-documents-list"></div>
    </div>

    <!-- Ingestion Progress (hidden by default) -->
    <div class="card" id="progress-section" style="display: none;">
        <div class="card-header">
            <h2 class="card-title">?? Ingestion Progress</h2>
        </div>
        
        <div id="progress-content"></div>
    </div>

    <!-- Directory Scanner -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">?? Scan Directory</h2>
        </div>
        
        <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                Directory Path:
            </label>
            <div style="display: flex; gap: 10px;">
                <input 
                    type="text" 
                    id="directory-path" 
                    placeholder="C:\Users\Gebruiker\OneDrive\Documenten\test" 
                    style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;"
                />
                <button class="btn btn-primary" onclick="scanDirectory()">
                    ?? Scan
                </button>
            </div>
            <div style="margin-top: 8px; font-size: 12px; color: #666;">
                ?? Tip: Your last used directory will be remembered
            </div>
        </div>
        
        <div id="scan-status" style="margin-top: 15px;"></div>
    </div>

    <!-- Scanned Documents -->
    <div class="card" id="documents-section" style="display: none;">
        <div class="card-header">
            <h2 class="card-title">?? Found Documents</h2>
            <div>
                <button class="btn btn-primary" onclick="selectAll()">Select All</button>
                <button class="btn btn-primary" onclick="deselectAll()" style="background: #666;">Deselect All</button>
            </div>
        </div>
        
        <div id="documents-list" style="max-height: 400px; overflow-y: auto;"></div>
        
        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--light);">
            <button class="btn btn-primary" onclick="ingestSelected()" id="ingest-btn">
                ?? Ingest Selected Documents
            </button>
            <span id="selected-count" style="margin-left: 15px; font-weight: 600;"></span>
        </div>
    </div>
</div>

<style>
.card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    margin-bottom: 30px;
    padding: 20px;
    transition: all 0.3s;
}

.card-header {
    margin-bottom: 15px;
}

.card-title {
    font-size: 18px;
    font-weight: 600;
    margin: 0;
}

.btn {
    padding: 10px 15px;
    border-radius: 5px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.3s;
}

.btn-primary {
    background: var(--primary);
    color: white;
    border: none;
}

.btn-primary:hover {
    background: var(--primary-dark);
}

.btn-danger {
    background: var(--danger);
    color: white;
    border: none;
}

.btn-danger:hover {
    background: var(--danger-dark);
}

.document-checkbox {
    display: flex;
    align-items: center;
    padding: 12px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    margin-bottom: 8px;
    transition: all 0.3s;
    cursor: pointer;
}

.document-checkbox:hover {
    background: var(--light);
    border-color: var(--primary);
}

.document-checkbox input[type="checkbox"] {
    margin-right: 12px;
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.document-info {
    flex: 1;
}

.document-name {
    font-weight: 600;
    color: #333;
    margin-bottom: 4px;
}

.document-meta {
    font-size: 12px;
    color: #666;
}

.progress-item {
    padding: 15px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    margin-bottom: 10px;
    transition: all 0.3s;
}

.progress-item.processing {
    border-color: var(--primary);
    background: rgba(102, 126, 234, 0.05);
}

.progress-item.success {
    border-color: var(--success);
    background: rgba(76, 175, 80, 0.05);
}

.progress-item.failed {
    border-color: var(--danger);
    background: rgba(244, 67, 54, 0.05);
}

.progress-item.skipped {
    border-color: var(--warning);
    background: rgba(255, 152, 0, 0.05);
}

.progress-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
}

.progress-icon {
    font-size: 20px;
}

.progress-filename {
    flex: 1;
    font-weight: 600;
    color: #333;
}

.progress-status {
    font-size: 12px;
    padding: 4px 10px;
    border-radius: 12px;
    font-weight: 600;
}

.progress-status.processing {
    background: var(--primary);
    color: white;
}

.progress-status.success {
    background: var(--success);
    color: white;
}

.progress-status.failed {
    background: var(--danger);
    color: white;
}

.progress-status.skipped {
    background: var(--warning);
    color: white;
}

.progress-details {
    font-size: 13px;
    color: #666;
}

.progress-bar-container {
    margin-top: 20px;
    padding: 15px;
    background: var(--light);
    border-radius: 8px;
}

.progress-bar {
    height: 30px;
    background: white;
    border-radius: 15px;
    overflow: hidden;
    position: relative;
    margin-bottom: 10px;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
    transition: width 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 14px;
}

.progress-summary {
    display: flex;
    justify-content: space-between;
    font-size: 14px;
    color: #666;
}

.spinner {
    display: inline-block;
    animation: spin 1s linear infinite;
}

table {
    font-size: 14px;
}

table tr:hover {
    background: rgba(102, 126, 234, 0.05);
}
</style>

<script>
let scannedDocuments = [];
let eventSource = null;

// LocalStorage keys
const LAST_DIRECTORY_KEY = 'wherespace_last_directory';
const DEFAULT_DIRECTORY = 'C:\\Users\\Gebruiker\\OneDrive\\Documenten\\test';

// Save directory to localStorage
function saveLastDirectory(path) {
    try {
        localStorage.setItem(LAST_DIRECTORY_KEY, path);
    } catch (error) {
        console.error('Error saving directory:', error);
    }
}

// Load last used directory or default
function loadLastDirectory() {
    try {
        const lastDir = localStorage.getItem(LAST_DIRECTORY_KEY);
        return lastDir || DEFAULT_DIRECTORY;
    } catch (error) {
        console.error('Error loading directory:', error);
        return DEFAULT_DIRECTORY;
    }
}

// Load statistics from API
async function loadStatistics() {
    try {
        const response = await fetch('/api/list_documents');
        const data = await response.json();
        
        if (data.success) {
            const documents = data.documents;
            const totalDocs = documents.length;
            const totalChunks = documents.reduce((sum, doc) => sum + doc.chunk_count, 0);
            const totalSize = documents.reduce((sum, doc) => sum + doc.file_size, 0);
            const avgChunkSize = totalChunks > 0 ? Math.round(totalSize / totalChunks) : 0;
            
            // Update statistics
            document.getElementById('stat-documents').textContent = totalDocs;
            document.getElementById('stat-chunks').textContent = totalChunks.toLocaleString();
            document.getElementById('stat-size').textContent = formatBytes(totalSize);
            document.getElementById('stat-avg-chunk').textContent = formatBytes(avgChunkSize);
            
            // Load documents list
            displayIndexedDocuments(documents);
        }
    } catch (error) {
        console.error('Error loading statistics:', error);
    }
}

// Format bytes to human readable
function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// Display indexed documents
function displayIndexedDocuments(documents) {
    const listDiv = document.getElementById('indexed-documents-list');
    
    if (documents.length === 0) {
        listDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No documents indexed yet. Scan a directory to get started!</p>';
        return;
    }
    
    listDiv.innerHTML = `
        <div style="margin-bottom: 15px;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: var(--light); text-align: left;">
                        <th style="padding: 12px; border-bottom: 2px solid #e0e0e0;">Document</th>
                        <th style="padding: 12px; border-bottom: 2px solid #e0e0e0;">Type</th>
                        <th style="padding: 12px; border-bottom: 2px solid #e0e0e0;">Size</th>
                        <th style="padding: 12px; border-bottom: 2px solid #e0e0e0;">Chunks</th>
                        <th style="padding: 12px; border-bottom: 2px solid #e0e0e0;">Ingested</th>
                    </tr>
                </thead>
                <tbody>
                    ${documents.map(doc => `
                        <tr style="border-bottom: 1px solid #f0f0f0;">
                            <td style="padding: 12px;">
                                <div style="font-weight: 600; color: #333;">?? ${doc.file_name}</div>
                                <div style="font-size: 11px; color: #999; margin-top: 2px;">${doc.file_path}</div>
                            </td>
                            <td style="padding: 12px;">
                                <span style="padding: 4px 8px; background: var(--light); border-radius: 4px; font-size: 12px; font-weight: 600;">
                                    ${doc.file_type.toUpperCase()}
                                </span>
                            </td>
                            <td style="padding: 12px; color: #666;">${doc.file_size_formatted}</td>
                            <td style="padding: 12px; color: #666;">${doc.chunk_count}</td>
                            <td style="padding: 12px; color: #999; font-size: 12px;">${doc.ingested_at || 'N/A'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

// Delete all documents
async function deleteAllDocuments() {
    if (!confirm('Are you sure you want to delete ALL indexed documents? This action cannot be undone!')) {
        return;
    }
    
    try {
        const response = await fetch('/api/flush_documents', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`Successfully deleted ${data.deleted_count} chunks from the database!`);
            // Reload statistics and list
            loadStatistics();
        } else {
            alert('Error deleting documents: ' + data.error);
        }
    } catch (error) {
        alert('Error deleting documents: ' + error.message);
    }
}

async function scanDirectory() {
    const pathInput = document.getElementById('directory-path');
    const path = pathInput.value.trim();
    
    if (!path) {
        alert('Please enter a directory path');
        return;
    }
    
    // Save this directory as the last used
    saveLastDirectory(path);
    
    const statusDiv = document.getElementById('scan-status');
    statusDiv.innerHTML = '<p style="color: var(--primary); font-weight: 600;">?? Scanning directory...</p>';
    
    try {
        const response = await fetch('/api/scan_directory', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: path })
        });
        
        const data = await response.json();
        
        if (data.success) {
            scannedDocuments = data.documents;
            displayDocuments(data.documents);
            statusDiv.innerHTML = `<p style="color: var(--success); font-weight: 600;">? Found ${data.count} documents</p>`;
        } else {
            statusDiv.innerHTML = `<p style="color: var(--danger); font-weight: 600;">? Error: ${data.error}</p>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<p style="color: var(--danger); font-weight: 600;">? Error: ${error.message}</p>`;
    }
}

function displayDocuments(documents) {
    const section = document.getElementById('documents-section');
    const listDiv = document.getElementById('documents-list');
    
    if (documents.length === 0) {
        listDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No documents found</p>';
        section.style.display = 'none';
        return;
    }
    
    section.style.display = 'block';
    
    listDiv.innerHTML = documents.map((doc, index) => `
        <label class="document-checkbox" for="doc-checkbox-${index}">
            <input type="checkbox" id="doc-checkbox-${index}" value="${index}" onchange="updateSelectedCount()">
            <div class="document-info">
                <div class="document-name">?? ${doc.name}</div>
                <div class="document-meta">
                    Type: ${doc.type.toUpperCase()} | Size: ${doc.size_formatted}
                </div>
            </div>
        </label>
    `).join('');
    
    updateSelectedCount();
}

function selectAll() {
    document.querySelectorAll('.document-checkbox input[type="checkbox"]').forEach(cb => cb.checked = true);
    updateSelectedCount();
}

function deselectAll() {
    document.querySelectorAll('.document-checkbox input[type="checkbox"]').forEach(cb => cb.checked = false);
    updateSelectedCount();
}

function updateSelectedCount() {
    const selected = document.querySelectorAll('.document-checkbox input[type="checkbox"]:checked').length;
    const countSpan = document.getElementById('selected-count');
    countSpan.textContent = `${selected} document(s) selected`;
}

async function ingestSelected() {
    const checkboxes = document.querySelectorAll('.document-checkbox input[type="checkbox"]:checked');
    const selectedIndices = Array.from(checkboxes).map(cb => parseInt(cb.value));
    
    if (selectedIndices.length === 0) {
        alert('Please select at least one document');
        return;
    }
    
    const selectedDocs = selectedIndices.map(i => scannedDocuments[i]);
    const filePaths = selectedDocs.map(doc => doc.path);
    
    const progressSection = document.getElementById('progress-section');
    const progressContent = document.getElementById('progress-content');
    const ingestBtn = document.getElementById('ingest-btn');
    
    // Show progress section at top and scroll to it
    progressSection.style.display = 'block';
    progressSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    ingestBtn.disabled = true;
    
    // Initialize progress display
    const total = filePaths.length;
    progressContent.innerHTML = `
        <div class="progress-bar-container">
            <div class="progress-bar">
                <div class="progress-bar-fill" id="overall-progress" style="width: 0%;">0%</div>
            </div>
            <div class="progress-summary">
                <span>Processing: <strong id="current-file">-</strong></span>
                <span><strong id="progress-count">0</strong> / ${total}</span>
            </div>
        </div>
        <div id="progress-items" style="max-height: 400px; overflow-y: auto; margin-top: 20px;"></div>
    `;
    
    // Use fetch with streaming for POST with SSE
    try {
        const response = await fetch('/api/ingest_documents', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ files: filePaths })
        });
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        
        const progressItems = document.getElementById('progress-items');
        const progressFill = document.getElementById('overall-progress');
        const progressCount = document.getElementById('progress-count');
        const currentFileSpan = document.getElementById('current-file');
        
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop();
            
            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    try {
                        const data = JSON.parse(line.slice(6));
                        console.log('Received event:', data.type, data);
                        
                        if (data.type === 'progress') {
                            // Update overall progress
                            const percent = (data.current / total * 100).toFixed(1);
                            progressFill.style.width = percent + '%';
                            progressFill.textContent = percent + '%';
                            progressCount.textContent = data.current;
                            currentFileSpan.textContent = data.file;
                            
                            // Add or update progress item
                            let itemId = `progress-${data.current}`;
                            let item = document.getElementById(itemId);
                            
                            if (!item) {
                                item = document.createElement('div');
                                item.id = itemId;
                                item.className = 'progress-item';
                                progressItems.appendChild(item);
                            }
                            
                            // Update item based on status
                            item.className = 'progress-item ' + data.status;
                             
                            let icon = '?';
                            let statusText = 'Processing';
                            let statusClass = 'processing';
                            let details = '';
                        
                            if (data.status === 'processing') {
                                icon = '<span class="spinner">?</span>';
                                statusText = 'Processing';
                            } else if (data.status === 'chunking') {
                                icon = '<span class="spinner">??</span>';
                                statusText = 'Chunking';
                                details = `Created ${data.chunks} chunks`;
                            } else if (data.status === 'embedding') {
                                icon = '<span class="spinner">??</span>';
                                statusText = 'Generating embeddings';
                            } else if (data.status === 'storing') {
                                icon = '<span class="spinner">??</span>';
                                statusText = 'Storing';
                            } else if (data.status === 'success') {
                                icon = '?';
                                statusText = 'Success';
                                statusClass = 'success';
                            } else if (data.status === 'failed') {
                                icon = '?';
                                statusText = 'Failed';
                                statusClass = 'failed';
                                details = data.reason || 'Unknown error';
                            } else if (data.status === 'skipped') {
                                icon = '??';
                                statusText = 'Skipped';
                                statusClass = 'skipped';
                                details = data.reason || 'Skipped';
                            }
                            
                            item.innerHTML = `
                                <div class="progress-header">
                                    <span class="progress-icon">${icon}</span>
                                    <span class="progress-filename">${data.file}</span>
                                    <span class="progress-status ${statusClass}">${statusText}</span>
                                </div>
                                ${details ? `<div class="progress-details">${details}</div>` : ''}

                            `;
                            
                            // Scroll to bottom
                            progressItems.scrollTop = progressItems.scrollHeight;
                            
                        } else if (data.type === 'evaluating') {
                            console.log('Evaluation starting...');
                            // Show evaluation message
                            currentFileSpan.textContent = 'Running evaluation...';
                            const evalMsg = document.createElement('div');
                            evalMsg.id = 'eval-message';
                            evalMsg.style.cssText = 'margin-top: 15px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; text-align: center;';
                            evalMsg.innerHTML = `
                                <div class="spinner" style="font-size: 24px; margin-bottom: 10px;">??</div>
                                <p style="font-weight: 600; color: var(--primary);">${data.message}</p>
                            `;
                            progressContent.appendChild(evalMsg);
                            
                        } else if (data.type === 'evaluation') {
                            console.log('Evaluation results received:', data);
                            
                            // Remove evaluation message
                            const evalMsg = document.getElementById('eval-message');
                            if (evalMsg) {
                                evalMsg.remove();
                            }
                            
                            // Display evaluation results
                            const assessment = data.assessment;
                            const results = data.results;
                            
                            const evalResults = document.createElement('div');
                            evalResults.style.cssText = 'margin-top: 20px; padding: 20px; background: white; border: 2px solid var(--' + assessment.color + '); border-radius: 12px;';
                            evalResults.innerHTML = `
                                <h3 style="color: var(--${assessment.color}); margin-bottom: 15px;">
                                    ${assessment.icon} RAG Evaluation Results
                                </h3>
                                <p style="font-size: 16px; margin-bottom: 20px; color: #666;">
                                    ${assessment.message}
                                </p>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                    <div style="text-align: center; padding: 15px; background: var(--light); border-radius: 8px;">
                                        <div style="font-size: 32px; font-weight: 700; color: var(--${assessment.color});">${results.hit_rate}%</div>
                                        <div style="font-size: 13px; color: #666;">Hit Rate</div>
                                    </div>
                                    <div style="text-align: center; padding: 15px; background: var(--light); border-radius: 8px;">
                                        <div style="font-size: 32px; font-weight: 700; color: var(--${assessment.color});">${results.mrr}</div>
                                        <div style="font-size: 13px; color: #666;">MRR Score</div>
                                    </div>
                                    <div style="text-align: center; padding: 15px; background: var(--light); border-radius: 8px;">
                                        <div style="font-size: 32px; font-weight: 700; color: var(--${assessment.color});">${results.avg_similarity}</div>
                                        <div style="font-size: 13px; color: #666;">Avg Similarity</div>
                                    </div>
                                    <div style="text-align: center; padding: 15px; background: var(--light); border-radius: 8px;">
                                        <div style="font-size: 32px; font-weight: 700; color: var(--success);">${results.hits}/${results.total_tests}</div>
                                        <div style="font-size: 13px; color: #666;">Tests Passed</div>
                                    </div>
                                </div>
                                
                                <div style="background: var(--light); padding: 15px; border-radius: 8px;">
                                    <h4 style="margin-bottom: 10px; color: #333;">?? Recommendations:</h4>
                                    <ul style="margin: 0; padding-left: 20px; line-height: 1.8; color: #666;">
                                        ${assessment.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                                    </ul>
                                </div>
                            `;
                            progressContent.appendChild(evalResults);
                            
                        } else if (data.type === 'evaluation_error') {
                            console.error('Evaluation error:', data.error);
                            // Remove evaluation message
                            const evalMsg = document.getElementById('eval-message');
                            if (evalMsg) {
                                evalMsg.remove();
                            }
                            
                            const errorMsg = document.createElement('div');
                            errorMsg.style.cssText = 'margin-top: 15px; padding: 15px; background: rgba(244, 67, 54, 0.1); border-radius: 8px; color: var(--danger);';
                            errorMsg.innerHTML = `<strong>?? Evaluation Error:</strong> ${data.error}`;
                            progressContent.appendChild(errorMsg);
                            
                        } else if (data.type === 'done') {
                            // Show completion summary
                            currentFileSpan.textContent = 'Complete!';
                            progressFill.style.width = '100%';
                            progressFill.textContent = '100%';
                                    
                            const summary = document.createElement('div');
                            summary.style.cssText = 'margin-top: 20px; padding: 20px; background: var(--light); border-radius: 8px; text-align: center;';
                            summary.innerHTML = `
                                <h3 style="color: var(--success); margin-bottom: 10px;">?? Ingestion Complete!</h3>
                                <p style="font-size: 16px; margin-bottom: 15px;">
                                    <strong>${data.ingested}</strong> documents ingested successfully<br>
                                    ${data.failed > 0 ? `<span style="color: var(--danger);">${data.failed} failed</span>` : ''}
                                </p>
                                <button onclick="loadStatistics()" class="btn btn-primary">Refresh Statistics</button>
                            `;
                            progressContent.appendChild(summary);
                            
                            ingestBtn.disabled = false;
                            
                            // Automatically refresh statistics
                            setTimeout(() => loadStatistics(), 1000);
                        }
                    } catch (parseError) {
                        console.error('Error parsing SSE data:', parseError, 'Line:', line);
                    }
                }
            }
        }
        
    } catch (error) {
        console.error('Ingestion error:', error);
        progressContent.innerHTML = `<p style="color: var(--danger); font-weight: 600;">? Error: ${error.message}</p>`;
        ingestBtn.disabled = false;
    }
}

// Load last used directory and statistics on page load
document.addEventListener('DOMContentLoaded', function() {
    const lastDirectory = loadLastDirectory();
    document.getElementById('directory-path').value = lastDirectory;
    
    // Load statistics and documents on page load
    loadStatistics();
});
{% endblock %}
